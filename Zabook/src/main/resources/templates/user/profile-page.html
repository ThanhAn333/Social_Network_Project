<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Page</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f0f2f5;
        }

        .profile-section {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .profile-pic {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        .post-container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .post {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 15px;
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .post-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .post-header .user-details {
            flex-grow: 1;
        }

        .post-header .username {
            font-weight: bold;
            margin: 0;
            font-size: 0.95rem;
            color: #050505;
        }

        .post-header .time {
            font-size: 0.85rem;
            color: #65676b;
            margin: 0;
        }

        .post-content {
            font-size: 0.95rem;
            color: #050505;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .post-content img {
            width: 100%;
            border-radius: 8px;
            margin-top: 10px;
        }

        .post-actions {
            display: flex;
            justify-content: space-around;
            border-top: 1px solid #e4e6eb;
            padding-top: 10px;
            margin-top: 10px;
        }

        .post-actions button {
            background: none;
            border: none;
            color: #65676b;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .post-actions button i {
            margin-right: 5px;
        }

        .post-actions button:hover {
            color: #1877f2;
        }
    </style>
</head>
<div th:replace="user/header"></div>

<body>

    <div class="container mt-4">
        <!-- Profile Section -->
        <div class="profile-section text-center">

            <a href="#" data-toggle="modal" data-target="#avatarModal">
                <img th:src="${currentuser.avatar != null} ? ${currentuser.avatar} : '/images/icon/person.svg'"
                    alt="Profile Picture" class="profile-pic">
            </a>

            <h3 th:text="${currentuser.firstName +' '+ currentuser.lastName}"></h3>

            <!-- ch·ªânh s·ª≠a Bio -->
            <div class="form-group">
                <!-- Hi·ªÉn th·ªã ti·ªÉu s·ª≠ -->
                <p id="bioDisplay" th:text="${currentuser.bio}"></p>

                <!-- Input ƒë·ªÉ ch·ªânh s·ª≠a ti·ªÉu s·ª≠, ·∫©n ban ƒë·∫ßu -->
                <textarea id="bioEdit" class="form-control" style="display: none;">[[${currentuser.bio}]]</textarea>

                <!-- Icon ch·ªânh s·ª≠a -->
                <button type="button" id="editBioBtn" class="btn btn-light mt-2 ">
                    <i class="fas fa-edit"></i> Ch·ªânh s·ª≠a ti·ªÉu s·ª≠
                </button>

                <!-- N√∫t l∆∞u, ·∫©n ban ƒë·∫ßu -->
                <button type="button" id="saveBioBtn" class="btn btn-primary mt-2" style="display: none;">
                    <i class="fas fa-save"></i> L∆∞u
                </button>
            </div>
            <!-- end ch·ªânh s·ª≠a Bio -->

            <div class="form-group">
                <!-- Hi·ªÉn th·ªã Gender -->
                <p id="genderDisplay" th:text="${'Gi·ªõi t√≠nh: '+ currentuser.gender}"></p>
                <select id="genderEdit" class="form-control" style="display: none;">
                    <option value="Nam" th:selected="${currentuser.gender == 'Nam'}">Nam</option>
                    <option value="N·ªØ" th:selected="${currentuser.gender == 'N·ªØ'}">N·ªØ</option>
                    <option value="Kh√°c" th:selected="${currentuser.gender == 'Kh√°c'}">Kh√°c</option>
                </select>

                <!-- Hi·ªÉn th·ªã Address -->
                <p id="addressDisplay" th:text="${'ƒê·ªãa ch·ªâ: '+currentuser.address}"></p>
                <textarea id="addressEdit" class="form-control" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ c·ªßa b·∫°n"
                    style="display: none;">[[${currentuser.address}]]</textarea>

                <!-- N√∫t ch·ªânh s·ª≠a v√† l∆∞u -->
                <button type="button" id="editProfileBtn" class="btn btn-primary mt-2">Ch·ªânh s·ª≠a th√¥ng tin</button>
                <button type="button" id="saveProfileBtn" class="btn btn-success mt-2" style="display: none;">L∆∞u</button>
            </div>


        </div>



        <div class="container mt-4">
            <!-- Post Section in a raised box -->
            <div class="post-section card shadow-sm p-4 bg-white rounded">
                <!-- Textarea for post content -->
                <textarea class="post-input form-control mb-3" rows="3" placeholder="What's on your mind?"></textarea>

                <!-- Display image or video preview -->
                <div id="file-preview" class="mb-3" style="display: none;">
                    <!-- Preview s·∫Ω ƒë∆∞·ª£c th√™m qua JavaScript -->
                </div>

                <div class="mb-3">
                    <label for="post-image" class="form-label">Add photos or videos</label>
                    <!-- Cho ph√©p ch·ªçn nhi·ªÅu t·ªáp v·ªõi multiple v√† h·ªó tr·ª£ h√¨nh ·∫£nh v√† video -->
                    <input type="file" class="form-control" id="post-image" accept="image/*, video/*" multiple>
                </div>



                <script>

                    document.addEventListener("DOMContentLoaded", function () {
                        const genderDisplay = document.getElementById("genderDisplay");
                        const genderEdit = document.getElementById("genderEdit");
                        const addressDisplay = document.getElementById("addressDisplay");
                        const addressEdit = document.getElementById("addressEdit");

                        const editProfileBtn = document.getElementById("editProfileBtn");
                        const saveProfileBtn = document.getElementById("saveProfileBtn");

                        editProfileBtn.addEventListener("click", function () {
                            genderDisplay.style.display = "none";
                            genderEdit.style.display = "block";

                            addressDisplay.style.display = "none";
                            addressEdit.style.display = "block";

                            editProfileBtn.style.display = "none";
                            saveProfileBtn.style.display = "inline-block";
                        });

                        saveProfileBtn.addEventListener("click", function () {
                            const updatedGender = genderEdit.value;
                            const updatedAddress = addressEdit.value;

                            // G·ª≠i d·ªØ li·ªáu v·ªÅ server
                            fetch('/user/profile/update_profile', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ gender: updatedGender, address: updatedAddress }),
                            })
                                .then(response => {
                                    if (response.ok) {
                                        genderDisplay.textContent = updatedGender || "Ch∆∞a ch·ªçn gi·ªõi t√≠nh";
                                        addressDisplay.textContent = updatedAddress || "Ch∆∞a nh·∫≠p ƒë·ªãa ch·ªâ";

                                        genderDisplay.style.display = "block";
                                        genderEdit.style.display = "none";

                                        addressDisplay.style.display = "block";
                                        addressEdit.style.display = "none";

                                        editProfileBtn.style.display = "inline-block";
                                        saveProfileBtn.style.display = "none";
                                    } else {
                                        alert("C·∫≠p nh·∫≠t th√¥ng tin th·∫•t b·∫°i!");
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    alert("ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t!");
                                });
                        });
                    });

                    const fileInput = document.getElementById('post-image');
                    const filePreviewContainer = document.getElementById('file-preview');

                    // H√†m ki·ªÉm tra xem file ƒë√£ ƒë∆∞·ª£c th√™m v√†o ch∆∞a
                    function isFileAlreadyAdded(file) {
                        const previews = filePreviewContainer.getElementsByClassName('file-preview-item');
                        for (let i = 0; i < previews.length; i++) {
                            const preview = previews[i];
                            const previewFile = preview.querySelector('img, video');
                            if (previewFile && previewFile.src === URL.createObjectURL(file)) {
                                return true;
                            }
                        }
                        return false;
                    }

                    fileInput.addEventListener('change', function () {
                        const files = fileInput.files;

                        // Duy·ªát qua c√°c file ƒë√£ ch·ªçn
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];

                            // Ki·ªÉm tra xem file ƒë√£ ƒë∆∞·ª£c th√™m ch∆∞a
                            if (isFileAlreadyAdded(file)) {
                                continue; // N·∫øu ƒë√£ th√™m, b·ªè qua v√† kh√¥ng th√™m file n√†y
                            }

                            // T·∫°o m·ªôt div cho m·ªói preview
                            const previewWrapper = document.createElement('div');
                            previewWrapper.classList.add('file-preview-item');
                            previewWrapper.style.position = 'relative';

                            // Ki·ªÉm tra lo·∫°i file l√† h√¨nh ·∫£nh hay video v√† hi·ªÉn th·ªã t∆∞∆°ng ·ª©ng
                            const fileReader = new FileReader();

                            fileReader.onload = function (e) {
                                const fileUrl = e.target.result;

                                if (file.type.startsWith('image')) {
                                    // Hi·ªÉn th·ªã h√¨nh ·∫£nh m√† kh√¥ng hi·ªÉn th·ªã t√™n file
                                    const img = document.createElement('img');
                                    img.src = fileUrl;
                                    img.classList.add('img-fluid');
                                    img.style.maxHeight = '200px';
                                    previewWrapper.appendChild(img);
                                } else if (file.type.startsWith('video')) {
                                    // Hi·ªÉn th·ªã video m√† kh√¥ng hi·ªÉn th·ªã t√™n file
                                    const video = document.createElement('video');
                                    video.src = fileUrl;
                                    video.controls = true;
                                    video.style.maxWidth = '200px';
                                    previewWrapper.appendChild(video);
                                }

                                // Th√™m n√∫t "x" ƒë·ªÉ x√≥a
                                const removeButton = document.createElement('button');
                                removeButton.innerHTML = '√ó';
                                removeButton.classList.add('remove-btn');
                                removeButton.style.position = 'absolute';
                                removeButton.style.top = '5px';
                                removeButton.style.right = '5px';
                                removeButton.style.background = 'rgba(0, 0, 0, 0.5)';
                                removeButton.style.color = 'white';
                                removeButton.style.border = 'none';
                                removeButton.style.borderRadius = '50%';
                                removeButton.style.padding = '5px';
                                removeButton.style.cursor = 'pointer';

                                // X·ª≠ l√Ω s·ª± ki·ªán x√≥a t·ªáp
                                removeButton.addEventListener('click', function () {
                                    previewWrapper.remove();
                                });

                                previewWrapper.appendChild(removeButton);
                                filePreviewContainer.appendChild(previewWrapper);
                            };

                            fileReader.readAsDataURL(file);
                        }

                        // Hi·ªÉn th·ªã ph·∫ßn preview sau khi c√≥ file ƒë∆∞·ª£c ch·ªçn
                        filePreviewContainer.style.display = 'block';
                    });


                    document.addEventListener("DOMContentLoaded", function () {
                        const bioDisplay = document.getElementById("bioDisplay");
                        const bioEdit = document.getElementById("bioEdit");
                        const editBioBtn = document.getElementById("editBioBtn");
                        const saveBioBtn = document.getElementById("saveBioBtn");

                        // Khi nh·∫•n v√†o n√∫t "Ch·ªânh s·ª≠a"
                        editBioBtn.addEventListener("click", function () {
                            bioDisplay.style.display = "none";
                            bioEdit.style.display = "block";
                            saveBioBtn.style.display = "inline-block";
                            editBioBtn.style.display = "none";
                        });

                        // Khi nh·∫•n v√†o n√∫t "L∆∞u"
                        saveBioBtn.addEventListener("click", function () {
                            const updatedBio = bioEdit.value;

                            // G·ª≠i d·ªØ li·ªáu v·ªÅ server b·∫±ng Fetch API
                            fetch('/user/profile/update_bio', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ bio: updatedBio }),
                            })
                                .then(response => {
                                    if (response.ok) {
                                        bioDisplay.textContent = updatedBio; // C·∫≠p nh·∫≠t bio hi·ªÉn th·ªã
                                        bioDisplay.style.display = "block";
                                        bioEdit.style.display = "none";
                                        saveBioBtn.style.display = "none";
                                        editBioBtn.style.display = "inline-block";
                                    } else {
                                        alert("C·∫≠p nh·∫≠t ti·ªÉu s·ª≠ th·∫•t b·∫°i!");
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    alert("ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t!");
                                });
                        });
                    });
                </script>

                <style>
                    /* Hi·ªáu ·ª©ng bo g√≥c v√† m∆∞·ª£t m√† cho card */
                    .post-section {
                        border-radius: 15px;
                        /* Bo g√≥c cho card */
                        background-color: white;
                        transition: box-shadow 0.3s ease-in-out;
                        /* Th√™m hi·ªáu ·ª©ng khi thay ƒë·ªïi box-shadow */
                    }

                    /* Th√™m hi·ªáu ·ª©ng khi hover v√†o card */
                    .post-section:hover {
                        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                        /* Hi·ªáu ·ª©ng ƒë·ªï b√≥ng khi hover */
                    }

                    /* ƒê·ªïi m√†u n·ªÅn cho textarea khi hover */
                    .post-input:focus {
                        border-color: #007bff;
                        /* M√†u vi·ªÅn khi focus */
                        box-shadow: 0 0 10px rgba(0, 123, 255, 0.2);
                        /* Hi·ªáu ·ª©ng √°nh s√°ng xung quanh khi focus */
                    }

                    #bioEdit {
                        width: 100%;
                        resize: none;
                    }

                    .fas.fa-edit,
                    .fas.fa-save {
                        margin-left: 8px;
                    }

                    /* T√πy ch·ªânh n√∫t x */
                    .remove-btn {
                        font-size: 18px;
                        font-weight: bold;
                        width: 22px;
                        height: 22px;
                        text-align: center;
                        line-height: 16px;
                        color: white;
                        background-color: #007bff;
                        /* M√†u n·ªÅn xanh bi·ªÉn */
                        border-radius: 50%;
                        cursor: pointer;
                        transition: background-color 0.3s ease;
                        /* Hi·ªáu ·ª©ng chuy·ªÉn m√†u n·ªÅn */
                    }

                    /* Hi·ªáu ·ª©ng hover cho n√∫t x */
                    .remove-btn:hover {
                        background-color: #0056b3;
                        /* M√†u n·ªÅn khi hover */
                    }

                    /* T√πy ch·ªânh ph·∫ßn preview ·∫£nh/video */
                    .file-preview-item {
                        display: inline-block;
                        margin-right: 10px;
                        margin-bottom: 10px;
                        position: relative;
                        border-radius: 10px;
                        /* Bo g√≥c cho preview */
                        overflow: hidden;
                        transition: transform 0.3s ease;
                        /* Hi·ªáu ·ª©ng khi di chu·ªôt v√†o */
                    }

                    /* Hi·ªáu ·ª©ng khi hover v√†o preview ·∫£nh/video */
                    .file-preview-item:hover {
                        transform: scale(1.05);
                        /* Ph√≥ng to nh·∫π khi hover */
                    }

                    /* N√∫t post */
                    .btn-primary {
                        background-color: #007bff;
                        /* M√†u n·ªÅn xanh bi·ªÉn */
                        border: none;
                        padding: 10px 20px;
                        font-size: 16px;
                        border-radius: 5px;
                        transition: background-color 0.3s ease;
                        /* Hi·ªáu ·ª©ng chuy·ªÉn m√†u n·ªÅn */
                    }

                    /* Hi·ªáu ·ª©ng hover cho n√∫t post */
                    .btn-primary:hover {
                        background-color: #0056b3;
                        /* M√†u n·ªÅn khi hover */
                    }

                    /* Ch·ªânh s·ª≠a ph·∫ßn preview file */
                    #file-preview {
                        display: flex;
                        flex-wrap: wrap;
                    }

                    /* T√πy ch·ªânh cho container c·ªßa file preview */
                    .file-preview-item img,
                    .file-preview-item video {
                        max-width: 150px;
                        border-radius: 10px;
                    }

                    .profile-pic,
                    #avatarPreview {
                        border-radius: 50%;
                        /* T·∫°o h√¨nh tr√≤n */
                        object-fit: cover;
                        /* ƒê·∫£m b·∫£o h√¨nh ·∫£nh kh√¥ng b·ªã m√©o */
                        width: 150px;
                        /* K√≠ch th∆∞·ªõc h√¨nh ·∫£nh (ƒëi·ªÅu ch·ªânh t√πy √Ω) */
                        height: 150px;
                        /* K√≠ch th∆∞·ªõc h√¨nh ·∫£nh */
                        display: block;
                        margin: 0 auto;
                        /* Canh gi·ªØa */
                    }
                </style>

                <div class="text-end">
                    <button class="btn btn-primary">Post</button>
                </div>
            </div>
        </div>





        <!-- Feed Section -->
        <div class="post-container">
            <h5 class="mb-3">Recent Posts</h5>

            <div class="post">
                <div class="post-header">
                    <img src="https://via.placeholder.com/40" alt="User Avatar">
                    <div class="user-details">
                        <p class="username">John Doe</p>
                        <p class="time">10 ph√∫t tr∆∞·ªõc</p>
                    </div>
                </div>
                <div class="post-content">
                    H√¥m nay l√† m·ªôt ng√†y tuy·ªát v·ªùi! üåû H√£y c√πng chia s·∫ª kho·∫£nh kh·∫Øc n√†y.
                    <img src="https://via.placeholder.com/600x300" alt="Post Image">
                </div>
                <div class="post-actions">
                    <button><i class="fas fa-thumbs-up"></i> Th√≠ch</button>
                    <button><i class="fas fa-comment-alt"></i> B√¨nh lu·∫≠n</button>
                    <button><i class="fas fa-share"></i> Chia s·∫ª</button>
                </div>
            </div>

        </div>
    </div>


    <!-- modal thay ƒë·ªïi avatar -->
    <div class="modal fade" id="avatarModal" tabindex="-1" role="dialog" aria-labelledby="avatarModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="avatarModalLabel">Avatar</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <!-- Enlarged Avatar -->
                    <img th:src="${currentuser.avatar != null} ? ${currentuser.avatar} : '/images/icon/person.svg'"
                        alt="Profile Picture" class="img-fluid">
                </div>
                <div class="modal-footer">
                    <!-- Change Avatar Button -->
                    <button type="button" class="btn btn-primary" data-toggle="modal"
                        data-target="#changeAvatarModal">ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="changeAvatarModal" tabindex="-1" role="dialog" aria-labelledby="changeAvatarModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changeAvatarModalLabel">ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form th:action="@{/user/profile/save_avatar}" method="post" enctype="multipart/form-data">
                    <div class="modal-body">
                        <!-- File Upload Input -->
                        <div class="form-group">
                            <label for="avatarUpload">T·∫£i ·∫£nh m·ªõi</label>
                            <input type="file" class="form-control" id="avatarUpload" name="avatar"
                                accept="image/png, image/jpeg, image/jpg" onchange="previewImage(this)">
                        </div>
                        <!-- Preview Uploaded Image -->
                        <div class="form-group text-center">
                            <img id="avatarPreview" src="/images/icon/person.svg" alt="Preview Avatar"
                                class="profile-pic" style="display: none;">
                        </div>


                        <!-- Choose from Available Avatars -->
                        <div class="form-group">
                            <label for="availableAvatars">Ch·ªçn t·ª´ h√¨nh ·∫£nh ƒë√£ ƒëƒÉng t·∫£i</label>
                            <div class="row">
                                <div class="col-4" th:each="avatar : ${currentuser.image}">
                                    <img th:src="${avatar}" th:data-value="${avatar}" alt="Avatar Option"
                                        class="img-thumbnail selectable-avatar" onclick="selectAvatar(this)">
                                </div>
                            </div>
                            <input type="hidden" id="selectedAvatar" name="selectedAvatar">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">L∆∞u</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        // Preview uploaded image
        function previewImage(input) {
            const preview = document.getElementById('avatarPreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
        // Select an avatar from existing images
        function selectAvatar(imgElement) {
            // Clear previous selections
            document.querySelectorAll('.selectable-avatar').forEach(img => {
                img.classList.remove('selected-avatar');
            });

            // Highlight the selected image
            imgElement.classList.add('selected-avatar');

            // Set the selected value
            const selectedValue = imgElement.getAttribute('data-value');
            document.getElementById('selectedAvatar').value = selectedValue;
        }
    </script>

    <!-- end modal thay ƒë·ªïi avatar -->



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>